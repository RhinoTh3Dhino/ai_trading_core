# ops/alertmanager/alertmanager.yml.tmpl
# BemÃ¦rk: renderes af am_init (envsubst), sÃ¥:
#   - bot_token SKAL vÃ¦re en streng => omgivet af anfÃ¸rselstegn
#   - chat_id SKAL vÃ¦re et heltal => ingen anfÃ¸rselstegn

global:
  resolve_timeout: 5m

route:
  receiver: telegram-default
  group_by: [alertname, job, instance]
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 4h
  routes:
    - matchers: ['severity="critical"']
      receiver: telegram-critical
      group_wait: 10s
      group_interval: 2m
      repeat_interval: 1h

receivers:
  - name: telegram-default
    telegram_configs:
      - bot_token: "${TELEGRAM_BOT_TOKEN}"   # skal vÃ¦re STRENG
        chat_id: ${TELEGRAM_CHAT_ID}         # skal vÃ¦re TAL (uden "")
        parse_mode: "HTML"
        send_resolved: true
        message: >-
          <b>{{ .CommonLabels.alertname }}</b> â€” status <b>{{ .Status | toUpper }}</b>
          {{- if .CommonLabels.severity }} (severity: <b>{{ .CommonLabels.severity }}</b>){{- end }}
          {{- if .CommonLabels.job }} Â· job: <code>{{ .CommonLabels.job }}</code>{{- end }}
          {{- if .CommonLabels.instance }} Â· instans: <code>{{ .CommonLabels.instance }}</code>{{- end }}
          {{- if .ExternalURL }} Â· <a href="{{ .ExternalURL }}">Alertmanager</a>{{- end }}
          {{- range .Alerts }}
          \nâ€¢ {{ .Annotations.summary }}
          {{- if .Labels.instance }} ({{ .Labels.instance }}){{- end }}
          {{- if .Annotations.description }}\n  {{ .Annotations.description }}{{- end }}
          {{- if .GeneratorURL }}\n  <a href="{{ .GeneratorURL }}">source</a>{{- end }}
          {{- end }}

  - name: telegram-critical
    telegram_configs:
      - bot_token: "${TELEGRAM_BOT_TOKEN}"
        chat_id: ${TELEGRAM_CHAT_ID}
        parse_mode: "HTML"
        send_resolved: true
        message: >-
          ðŸš¨ <b>CRITICAL</b> â€” {{ .CommonLabels.alertname }}
          {{- if .CommonLabels.job }} Â· job: <code>{{ .CommonLabels.job }}</code>{{- end }}
          {{- if .CommonLabels.instance }} Â· instans: <code>{{ .CommonLabels.instance }}</code>{{- end }}
          {{- range .Alerts }}
          \nâ€¢ {{ or .Annotations.summary .Annotations.description }}
          {{- end }}
          {{- if .ExternalURL }} Â· <a href="{{ .ExternalURL }}">Alertmanager</a>{{- end }}

inhibit_rules:
  - source_matchers: ['severity="critical"']
    target_matchers: ['severity="warning"']
    equal: [alertname, job, instance]

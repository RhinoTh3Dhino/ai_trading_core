# .github/workflows/alerting-ci.yml
name: Alerting CI

on:
  pull_request:
    paths:
      - "ops/alertmanager/**"
      - "ops/prometheus/**"
      - "tests/**"
      - "requirements.txt"
      - ".github/workflows/alerting-ci.yml"
  push:
    branches: [ main, master ]
    paths:
      - "ops/alertmanager/**"
      - "ops/prometheus/**"
      - "tests/**"
      - "requirements.txt"
      - ".github/workflows/alerting-ci.yml"

jobs:
  check-alerting:
    name: Prometheus, Alertmanager & Tests
    runs-on: ubuntu-latest

    env:
      # Dummy-secrets til render af Alertmanager-konfig i CI
      TELEGRAM_BOT_TOKEN: "ci_dummy_token_1234567890"
      TELEGRAM_CHAT_ID: "123456789"
      AM_RENDER_DIR: /tmp/amcfg

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---------------------------
      # Python tests (headless) + isolér fra runnerens systempakker
      # ---------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install deps
        run: pip install -r requirements.txt

      - name: Headless + ignorer usersite
        run: |
          echo "MPLBACKEND=Agg" >> $GITHUB_ENV
          echo "PYTHONNOUSERSITE=1" >> $GITHUB_ENV

      # Nogle Ubuntu-runnere har "pandas-ta/numba" i base-layers.
      # Afinstallér defensivt for at undgå coverage/numba-konflikt.
      - name: Ensure pandas-ta/numba not present
        run: pip uninstall -y pandas-ta numba || true

      # Tving korrekt coverage-version og vis import-sti (debug)
      - name: Force coverage version
        run: |
          pip install --force-reinstall --upgrade "coverage==7.5.3"
          python - <<'PY'
          import coverage, sys
          print("COVERAGE:", coverage.__version__, "FROM:", coverage.__file__)
          PY

      - name: Run pytest (quiet)
        run: pytest -q

      # ---------------------------
      # Prometheus valideringer
      # ---------------------------
      - name: promtool check config (prometheus.yml)
        run: |
          docker run --rm \
            -v "$PWD/ops/prometheus:/etc/prometheus:ro" \
            prom/prometheus:latest \
            promtool check config /etc/prometheus/prometheus.yml

      - name: promtool check rules (alerts.yml)
        run: |
          docker run --rm \
            -v "$PWD/ops/prometheus:/etc/prometheus:ro" \
            prom/prometheus:latest \
            promtool check rules /etc/prometheus/alerts.yml

      # ---------------------------
      # Alertmanager render + check
      # ---------------------------
      - name: Render Alertmanager config (envsubst med dummy-secrets)
        run: |
          mkdir -p "$AM_RENDER_DIR"
          docker run --rm \
            -e TELEGRAM_BOT_TOKEN="${TELEGRAM_BOT_TOKEN}" \
            -e TELEGRAM_CHAT_ID="${TELEGRAM_CHAT_ID}" \
            -v "$PWD/ops/alertmanager/alertmanager.runtime.yml:/tmpl/alertmanager.yml.tmpl:ro" \
            -v "$AM_RENDER_DIR:/amcfg" \
            alpine:3.20 \
            sh -lc '
              set -euo pipefail
              apk add --no-cache gettext >/dev/null
              # Render KUN de to forventede variabler (vigtigt: enkelt-anførselstegn)
              envsubst '"'"'${TELEGRAM_BOT_TOKEN} ${TELEGRAM_CHAT_ID}'"'"' \
                </tmpl/alertmanager.yml.tmpl \
                > /amcfg/alertmanager.yml
              echo "[CI] Rendered /amcfg/alertmanager.yml (first 30 lines):"
              head -n 30 /amcfg/alertmanager.yml || true
              # Sanity: tjek at felterne findes
              grep -q "bot_token:" /amcfg/alertmanager.yml
              grep -q "chat_id:" /amcfg/alertmanager.yml
            '

      - name: amtool check-config (rendered alertmanager.yml + templates)
        run: |
          docker run --rm \
            -v "$AM_RENDER_DIR:/amcfg:ro" \
            -v "$PWD/ops/alertmanager/templates:/etc/alertmanager/templates:ro" \
            prom/alertmanager:v0.27.0 \
            amtool check-config /amcfg/alertmanager.yml

      # ---------------------------
      # Artefakter ved fejl
      # ---------------------------
      - name: Upload rendered Alertmanager config (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: rendered-alertmanager
          path: /tmp/amcfg/alertmanager.yml
          if-no-files-found: warn

name: CI

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]
  workflow_dispatch:
  schedule:
    - cron: "5 1 * * *" # 01:05 UTC ≈ 03:05 DK (sommertid)

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      MPLBACKEND: Agg
      PYTHONUNBUFFERED: "1"
      CI: "true"
      PIP_DISABLE_PIP_VERSION_CHECK: "1"
      PIP_NO_INPUT: "1"
    steps:
      - name: Checkout kode
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        id: setup-python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Cache pip (ekstra)
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-py${{ steps.setup-python.outputs.python-version }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-py${{ steps.setup-python.outputs.python-version }}-pip-
            ${{ runner.os }}-pip-

      - name: Forbered CI-kravfiler (fjern pandas-ta/pandas_ta linjer)
        run: |
          set -e
          if [ -f requirements.txt ]; then
            cp requirements.txt requirements.ci.txt
            # Fjern eventuelle linjer for pandas-ta eller pandas_ta (vi pre-installerer dem)
            sed -E -i '/^[[:space:]]*(pandas-ta|pandas_ta)([^A-Za-z0-9._-].*)?$/d' requirements.ci.txt || true
            echo "== requirements.ci.txt =="; cat requirements.ci.txt
          fi
          if [ -f requirements-dev.txt ]; then
            cp requirements-dev.txt requirements-dev.ci.txt
            sed -E -i '/^[[:space:]]*(pandas-ta|pandas_ta)([^A-Za-z0-9._-].*)?$/d' requirements-dev.ci.txt || true
            echo "== requirements-dev.ci.txt =="; cat requirements-dev.ci.txt
          fi

      - name: Installer base-værktøjer
        run: |
          python -m pip install -U pip wheel setuptools
          python -V
          pip -V

      - name: Installér numeric stack først (hjul)
        run: |
          # Numpy før alt andet, så build-deps kan finde det
          pip install --only-binary=:all: numpy==1.26.4
          # Undgå at bygge numba/llvmlite fra kilde
          pip install --only-binary=:all: llvmlite==0.42.0 numba==0.59.1

      - name: Installér pandas-ta (OpenBB-fork) + shim til import
        run: |
          set -e
          # 1) Prøv at importere pandas_ta; hvis det fejler, brug OpenBB-forken
          python - <<'PY'
          import importlib, sys, subprocess, site, pathlib
          def has_pkg(name):
              try:
                  importlib.import_module(name)
                  return True
              except Exception:
                  return False

          if not has_pkg("pandas_ta"):
              print("pandas_ta ikke fundet – installerer pandas-ta-openbb…")
              subprocess.check_call([sys.executable, "-m", "pip", "install", "pandas-ta-openbb==0.4.22"])
              if not has_pkg("pandas_ta"):
                  # Lav en lille shim, hvis modulet ikke eksporterer navnet direkte
                  sp = site.getsitepackages()[0]
                  shim = pathlib.Path(sp) / "pandas_ta.py"
                  shim.write_text("from pandas_ta_openbb import *  # shim\n")
                  print(f"Shim oprettet: {shim}")
              else:
                  print("pandas_ta kan importeres efter install.")
          else:
              print("pandas_ta allerede tilgængelig.")
          PY

      - name: Installer projekt-afhængigheder
        run: |
          set -e
          if [ -f requirements.ci.txt ]; then pip install -r requirements.ci.txt; fi
          if [ -f requirements-dev.ci.txt ]; then pip install -r requirements-dev.ci.txt; fi
          # Sikkerhedsnet
          pip install pytest pytest-cov pytest-timeout || true
          # CPU-only torch (ignorér fejl hvis ikke nødvendigt i tests)
          pip install --extra-index-url https://download.pytorch.org/whl/cpu 'torch==2.2.2' 'torchvision==0.17.2' 'torchaudio==2.2.2' || true

      - name: Skriv .env til CI (testmode)
        run: |
          cat > .env << 'EOF'
          TELEGRAM_TOKEN=dummy_token
          TELEGRAM_CHAT_ID=12345
          TELEGRAM_TESTMODE_ALWAYS_ENABLED=1
          LOG_DIR=logs
          ANTHROPIC_API_KEY=
          CLAUDE_MODEL=claude-3-haiku-20240307
          EOF
          printf "CI .env content:\n"; sed 's/\(ANTHROPIC_API_KEY=\).*/\1****/' .env

      - name: Opret reports-mappe
        run: mkdir -p reports

      - name: Kør pytest
        run: pytest -q

      - name: Kør main.py (smoke)
        run: python main.py || true

      - name: Fail-safe artefakter
        run: |
          mkdir -p outputs graphs logs
          : > BotStatus.md
          : > CHANGELOG.md
          touch outputs/performance_history.csv
          touch outputs/balance_trend.png
          if [ ! -s outputs/performance_history.csv ]; then
            echo "timestamp,Navn,Balance" > outputs/performance_history.csv
          fi

      - name: Tjek outputfiler
        run: |
          test -f outputs/performance_history.csv
          test -f outputs/balance_trend.png
          test -f BotStatus.md
          test -f CHANGELOG.md
          echo "✅ Alle vigtige outputfiler findes!"

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ github.run_id }}
          path: |
            outputs/
            logs/
            graphs/
            htmlcov/
            reports/
            BotStatus.md
            CHANGELOG.md
            !**/*.pyc
            !**/__pycache__/
          retention-days: 7

      - name: Telegram notification (CI-status)
        if: ${{ always() }}
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          GITHUB_WORKFLOW: ${{ github.workflow }}
          GITHUB_RUN_NUMBER: ${{ github.run_number }}
          GITHUB_JOB: ${{ github.job }}
          GITHUB_RUN_ATTEMPT: ${{ github.run_attempt }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          CI_STATUS: ${{ job.status }}
        run: |
          if [ -n "${TELEGRAM_TOKEN}" ] && [ -n "${TELEGRAM_CHAT_ID}" ]; then
            python utils/ci_notify.py || true
          else
            echo "Skipping Telegram notify: secrets not configured."
          fi

  nightly-backup-verify:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      PYTHONUNBUFFERED: "1"
    steps:
      - name: Checkout kode
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Installer minimale afhængigheder
        run: |
          python -m pip install -U pip
          if [ -f requirements.txt ]; then
            cp requirements.txt requirements.ci.txt
            sed -E -i '/^[[:space:]]*(pandas-ta|pandas_ta)([^A-Za-z0-9._-].*)?$/d' requirements.ci.txt || true
            pip install -r requirements.ci.txt
          fi
          pip install pytest || true

      - name: Opret dummy data + ZIP-backup
        run: |
          python - << 'PY'
          from pathlib import Path
          from bot.utils.backup import create_backup
          root = Path("tmp_src"); root.mkdir(exist_ok=True)
          (root/"file.txt").write_text("ok", encoding="utf-8")
          backups = Path("backups"); backups.mkdir(exist_ok=True)
          zp = create_backup(str(root), str(backups))
          print("ZIP:", zp)
          PY

      - name: Verify (dry-run) og log til BotStatus.md
        run: |
          python -m bot.tools.backup_verify --backups backups --botstatus BotStatus.md --pattern "*.zip" --dry-run

      - name: Upload BotStatus.md (nightly)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: BotStatus-nightly-${{ github.run_id }}
          path: BotStatus.md

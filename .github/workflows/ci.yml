name: CI

on:
  push:
    branches: [ "*" ]
  pull_request:
    branches: [ "*" ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout kode
      uses: actions/checkout@v4

    - name: Sæt Python op
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Installer pip & afhængigheder
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Kør pytest på tests/
      run: |
        pytest tests/

    # Kør AI trading bot flow som end-to-end test (main.py)
    - name: Kør main.py (full flow)
      run: |
        python main.py

    # Upload artifacts: outputs, tests, logs og grafer
    - name: Upload artifacts (outputs, tests, logs, grafer)
      if: always()  # Kør selv ved fejl!
      uses: actions/upload-artifact@v4
      with:
        name: outputs-and-tests
        path: |
          outputs/
          tests/
          logs/
          graphs/
          !**/*.pyc
          !**/__pycache__/

    # Tjek struktur og dependencies
    - name: Check struktur og dependencies
      run: echo "✅ Struktur og artifacts OK"

    # Bonus: Tilføj linters, coverage og Telegram-notifikation senere
    # - name: Kør lint (fx black, flake8)
    #   run: |
    #     pip install black flake8
    #     black --check .
    #     flake8 .

    # - name: Coverage
    #   run: |
    #     pip install coverage
    #     coverage run -m pytest
    #     coverage report

    # - name: Telegram notification (optional)
    #   run: |
    #     python utils/telegram_utils.py --ci-report


name: CI

on:
  push:
    branches: [ "*" ]
  pull_request:
    branches: [ "*" ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout kode
      uses: actions/checkout@v4

    - name: Sæt Python op
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Installer pip & afhængigheder
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Kør pytest på tests/
      run: |
        pytest tests/

    - name: Kør main.py (kun én cyklus i CI)
      env:
        CI: "true"
      run: |
        python main.py

    # ==== NYT: Tjek at nøglefiler eksisterer (fail hvis ikke) ====
    - name: Tjek at alle centrale outputfiler findes
      run: |
        test -f outputs/performance_history.csv
        test -f outputs/balance_trend.png
        test -f BotStatus.md
        test -f CHANGELOG.md
        echo "✅ Alle vigtige outputfiler findes!"

    # ==== Upload artifacts: outputs, tests, logs, grafer ====
    - name: Upload artifacts (outputs, tests, logs, grafer)
      if: always()  # Kør selv ved fejl!
      uses: actions/upload-artifact@v4
      with:
        name: outputs-and-tests
        path: |
          outputs/
          tests/
          logs/
          graphs/
          !**/*.pyc
          !**/__pycache__/

    # ==== Struktur og dependencies tjek ====
    - name: Check struktur og dependencies
      run: echo "✅ Struktur og artifacts OK"

    # BONUS: Linter, coverage og evt. telegram/discord/slack notification
    # - name: Kør lint (fx black, flake8)
    #   run: |
    #     pip install black flake8
    #     black --check .
    #     flake8 .

    # - name: Coverage
    #   run: |
    #     pip install coverage
    #     coverage run -m pytest
    #     coverage report

    # - name: Telegram notification (optional)
    #   run: |
    #     python utils/telegram_utils.py --ci-report

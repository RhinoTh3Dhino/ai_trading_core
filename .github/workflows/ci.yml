name: CI

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]
  workflow_dispatch:
  schedule:
    - cron: "5 1 * * *" # 01:05 UTC ≈ 03:05 Europe/Copenhagen (sommertid)

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      MPLBACKEND: Agg
      PYTHONUNBUFFERED: "1"
      CI: "true"
    steps:
      - name: Checkout kode
        uses: actions/checkout@v4

      - name: Setup Python 3.11 (bedre hjul-kompatibilitet)
        id: setup-python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Verificér at Python 3.11 er aktiv
        run: |
          set -e
          python -V
          which python
          python - << 'PY'
          import sys
          print("Running:", sys.version)
          assert sys.version_info[:2] == (3, 11), "Forkert Python-version i PATH (forventer 3.11)"
          PY

      - name: Cache pip (ekstra, oveni setup-python cache)
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-py${{ steps.setup-python.outputs.python-version }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-py${{ steps.setup-python.outputs.python-version }}-pip-
            ${{ runner.os }}-pip-

      - name: Forbered CI-krav- og constraints-filer
        run: |
          set -e
          if [ -f requirements.txt ]; then
            cp requirements.txt requirements.ci.txt
            sed -E -i '/^[[:space:]]*(pandas_ta|pandas-ta)([=<>!].*)?([[:space:]]*)$/d' requirements.ci.txt || true
            echo "== requirements.ci.txt =="; cat requirements.ci.txt
          fi
          if [ -f requirements-dev.txt ]; then
            cp requirements-dev.txt requirements-dev.ci.txt
            sed -E -i '/^[[:space:]]*(pandas_ta|pandas-ta)([=<>!].*)?([[:space:]]*)$/d' requirements-dev.ci.txt || true
            echo "== requirements-dev.ci.txt =="; cat requirements-dev.ci.txt
          fi
          cat > constraints.ci.txt << 'C'
          numpy==1.26.4
          numba==0.61.0
          llvmlite==0.44.0
          C
          echo "== constraints.ci.txt =="; cat constraints.ci.txt

      - name: Preinstallér binære hjul for numba/llvmlite (+ numpy)
        run: |
          set -e
          pip install --upgrade pip wheel setuptools
          pip install --only-binary=:all: -c constraints.ci.txt \
            "numpy==1.26.4" "llvmlite==0.44.0" "numba==0.61.0"
          python - << 'PY'
          import importlib, numpy
          print("numpy:", numpy.__version__)
          for m in ("llvmlite","numba"):
              importlib.import_module(m)
              print(m, "OK")
          PY

      - name: Installer øvrige afhængigheder (med constraints)
        run: |
          set -e
          if [ -f requirements.ci.txt ]; then pip install --pre -c constraints.ci.txt -r requirements.ci.txt; fi
          if [ -f requirements-dev.ci.txt ]; then pip install --pre -c constraints.ci.txt -r requirements-dev.ci.txt; fi
          pip install pytest pytest-cov pytest-timeout || true
          pip install --extra-index-url https://download.pytorch.org/whl/cpu 'torch==2.2.2' 'torchvision==0.17.2' 'torchaudio==2.2.2' || true
          python -V
          pip -V

      - name: Installer pandas-ta uden git (PyPI→codeload→zip)
        env:
          PIP_DEFAULT_TIMEOUT: "60"
        run: |
          set -e
          python - << 'PY'
          import sys, subprocess, importlib
          def run(cmd: str) -> bool:
              print(f"\n-> {cmd}")
              try:
                  subprocess.check_call(cmd, shell=True)
                  return True
              except subprocess.CalledProcessError as e:
                  print(f"FAILED ({e.returncode})")
                  return False

          # 1) Prøv PyPI (tillad prereleases)
          if run(f"{sys.executable} -m pip install --pre pandas-ta"):
              pass
          # 2) Prøv codeload ZIP (kræver ikke git)
          elif run(f"{sys.executable} -m pip install 'pandas-ta @ https://codeload.github.com/twopirllc/pandas-ta/zip/refs/heads/master'"):
              pass
          # 3) Prøv GitHub ZIP-URL
          elif run(f"{sys.executable} -m pip install 'pandas-ta @ https://github.com/twopirllc/pandas-ta/archive/refs/heads/master.zip'"):
              pass
          else:
              raise SystemExit("Kunne ikke installere pandas-ta fra nogen kilde")

          import pandas_ta
          print("pandas_ta import OK")
          PY

      - name: Skriv .env til CI (testmode, ingen rigtige netkald)
        run: |
          cat > .env << 'EOF'
          TELEGRAM_TOKEN=dummy_token
          TELEGRAM_CHAT_ID=12345
          TELEGRAM_TESTMODE_ALWAYS_ENABLED=1
          LOG_DIR=logs
          # Tving mock i evaluation/claude_eval.py (ingen eksternt API-kald i CI)
          ANTHROPIC_API_KEY=
          CLAUDE_MODEL=claude-3-haiku-20240307
          EOF
          printf "CI .env content:\n"; sed 's/\(ANTHROPIC_API_KEY=\).*/\1****/' .env

      - name: Opret reports-mappe (hvis ikke findes)
        run: mkdir -p reports

      - name: Kør pytest
        run: |
          pytest -q

      - name: Kør main.py (smoke, må ikke vælte CI)
        run: |
          python main.py || true

      - name: Fail-safe artefakter (garantér at de findes)
        run: |
          mkdir -p outputs graphs logs
          : > BotStatus.md
          : > CHANGELOG.md
          touch outputs/performance_history.csv
          touch outputs/balance_trend.png
          if [ ! -s outputs/performance_history.csv ]; then
            echo "timestamp,Navn,Balance" > outputs/performance_history.csv
          fi

      - name: Tjek at centrale outputfiler findes
        run: |
          test -f outputs/performance_history.csv
          test -f outputs/balance_trend.png
          test -f BotStatus.md
          test -f CHANGELOG.md
          echo "✅ Alle vigtige outputfiler findes!"

      - name: Upload artifacts (outputs, logs, grafer, coverage/htmlcov, junit)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ github.run_id }}
          path: |
            outputs/
            logs/
            graphs/
            htmlcov/
            reports/
            BotStatus.md
            CHANGELOG.md
            !**/*.pyc
            !**/__pycache__/
          retention-days: 7

      - name: Telegram notification (CI-status)
        if: ${{ always() }}
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          GITHUB_WORKFLOW: ${{ github.workflow }}
          GITHUB_RUN_NUMBER: ${{ github.run_number }}
          GITHUB_JOB: ${{ github.job }}
          GITHUB_RUN_ATTEMPT: ${{ github.run_attempt }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          CI_STATUS: ${{ job.status }}
        run: |
          if [ -n "${TELEGRAM_TOKEN}" ] && [ -n "${TELEGRAM_CHAT_ID}" ]; then
            python utils/ci_notify.py || true
          else
            echo "Skipping Telegram notify: secrets not configured."
          fi

  nightly-backup-verify:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      PYTHONUNBUFFERED: "1"
    steps:
      - name: Checkout kode
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        id: setup-python-nightly
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Installer minimale afhængigheder (med constraints)
        run: |
          set -e
          python -m pip install -U pip wheel setuptools
          cat > constraints.ci.txt << 'C'
          numpy==1.26.4
          numba==0.61.0
          llvmlite==0.44.0
          C
          if [ -f requirements.txt ]; then
            cp requirements.txt requirements.ci.txt
            sed -E -i '/^[[:space:]]*(pandas_ta|pandas-ta)([=<>!].*)?([[:space:]]*)$/d' requirements.ci.txt || true
            pip install --pre -c constraints.ci.txt -r requirements.ci.txt
          fi
          pip install pytest || true

      - name: Opret dummy data + ZIP-backup
        run: |
          python - << 'PY'
          from pathlib import Path
          from bot.utils.backup import create_backup
          root = Path("tmp_src"); root.mkdir(exist_ok=True)
          (root/"file.txt").write_text("ok", encoding="utf-8")
          backups = Path("backups"); backups.mkdir(exist_ok=True)
          zp = create_backup(str(root), str(backups))
          print("ZIP:", zp)
          PY

      - name: Verify (dry-run) og log til BotStatus.md
        run: |
          python -m bot.tools.backup_verify --backups backups --botstatus BotStatus.md --pattern "*.zip" --dry-run

      - name: Upload BotStatus.md (nightly)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: BotStatus-nightly-${{ github.run_id }}
          path: BotStatus.md

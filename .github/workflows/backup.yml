---
name: Auto Backup

on:
  push:
    branches: [ "ai_bot_dev", "ai_bot_test", "ai_bot_pro" ]
  schedule:
    - cron: "0 3 * * *"   # Daily at 03:00 UTC
  workflow_dispatch:

concurrency:
  group: backup-${{ github.ref }}
  cancel-in-progress: true

jobs:
  backup:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      PYTHONUNBUFFERED: "1"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        id: setup-python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Print Python & pip versions
        run: |
          python -V
          pip -V

      # Prepare: install compatible pandas-ta, add shim so 'import pandas_ta' works,
      # and filter pandas-ta/pandas_ta out of requirements before pip install.
      - name: Prepare dependencies (pandas-ta fix)
        run: |
          set -e
          python -m pip install -U pip wheel

          python - <<'PY'
          import sys, subprocess, importlib, site, pathlib
          try:
              importlib.import_module("pandas_ta")
              print("pandas_ta already available")
          except Exception:
              # Try community-maintained fork that still ships wheels
              subprocess.check_call([sys.executable, "-m", "pip", "install", "pandas-ta-openbb==0.4.22"])
              try:
                  importlib.import_module("pandas_ta")
                  print("pandas_ta import OK after installing pandas-ta-openbb")
              except Exception:
                  # Last resort: create a shim so 'import pandas_ta' resolves
                  target = pathlib.Path(site.getsitepackages()[0]) / "pandas_ta.py"
                  target.write_text("from pandas_ta_openbb import *\n")
                  print(f"Shim written: {target}")
          PY

          if [ -f requirements.txt ]; then
            cp requirements.txt requirements.ci.txt
            sed -E -i '/^[[:space:]]*(pandas-ta|pandas_ta)([^A-Za-z0-9._-].*)?$/d' requirements.ci.txt || true
            echo "== requirements.ci.txt =="; cat requirements.ci.txt
          fi

      - name: Install dependencies
        run: |
          if [ -f requirements.ci.txt ]; then
            pip install -r requirements.ci.txt
          fi

      - name: Run backup.py
        run: |
          if [ -f backup.py ]; then
            echo ">> Running backup script..."
            python backup.py
          else
            echo "WARNING: backup.py not found - skipping backup step."
          fi

      - name: Ensure backups dir exists
        if: ${{ always() }}
        run: mkdir -p backups

      - name: Upload backup artifact
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: backup-${{ github.run_id }}
          path: backups/
          retention-days: 14

      - name: Print backup-log summary
        if: ${{ always() }}
        run: |
          echo "Auto Backup: workflow completed - check artifacts or logs for details"
